<div class="flex justify-center flex-col lg:flex-row container mx-auto pb-4 select-none px-[3%]">
  <!-- Left panel: the grid -->
  <div class="inventory-view container">
    @for (row of hotmServ.grid; let rwIdx = $index; track rwIdx) {
      @for (cell of row; let colIdx = $index; track colIdx) {
        @if (cell) {
          <div
            class="inventory-slot rich-item"
            (click)="onCellClick(colIdx, rwIdx)"
            [id]="'cell_' + colIdx + '_' + rwIdx"
            [ngClass]="{
              selected: selectedPos()?.x === colIdx && selectedPos()!.y === rwIdx,
            }"
          >
            <div class="item-icon piece-icon" [ngClass]="cell.cssClass()()"></div>
          </div>
        } @else {
          <div class="inventory-slot" [id]="'cell_' + colIdx + '_' + rwIdx"></div>
        }
      }
    }
  </div>
  <!-- Right panel: the picker -->
  <div class="container flex justify-center flex-col max-lg:mt-4 gap-3">
    <!-- Tooltip box -->
    <div id="tooltip-box"
         class="w-full bg-gray-800/40 p-3 rounded-md border min-h-[250px] flex flex-col items-center justify-center border-gray-500">
      @if (selectedPos()) {
        @let pos = selectedPos()!;
        @let selectedNode = hotmServ.grid[pos.y][pos.x];
        <div class="w-full">
          @switch (selectedNode.type) {
            @case ("ability") {
              <sb-hotm-card [instance]="selectedNode" [isLevelable]="false" />
            }
            @case ("static") {
              <sb-hotm-card [instance]="selectedNode" [isLevelable]="false" />
            }
            @case ("levelable") {
              <sb-hotm-card [instance]="selectedNode" [isLevelable]="true" />
            }
          }
        </div>
      } @else {
        <div class="flex flex-col justify-center items-center">
          <span class="mc gray">Select a perk to see its description!</span>
        </div>
      }
    </div>

    <!-- Powder and Tools panel -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Powder panel -->
      @let total = hotmServ.totalPowder();
      <div class="bg-gray-800/40 p-5 rounded-md !border-gray-500 border">
        <h2 class="text-xl font-bold text-emerald-400 mb-4">Powders</h2>
        <div class="space-y-3">
          <div
            class="flex items-center justify-between p-3 rounded-lg border border-slate-400/60 bg-white/10 backdrop-blur-md">
            <span class="text-[#00AA00] font-semibold">Mithril</span>
            <span class="text-[#00AA00] font-bold">{{ format(total.mithril) }}</span>
          </div>
          <div
            class="flex items-center justify-between p-3 rounded-lg border border-slate-400/60 bg-white/10 backdrop-blur-md">
            <span class="text-[#FF55FF] font-semibold">Gemstone</span>
            <span class="text-[#FF55FF] font-bold">{{ format(total.gemstone) }}</span>
          </div>
          <div
            class="flex items-center justify-between p-3 rounded-lg border border-slate-400/60 bg-white/10 backdrop-blur-md">
            <span class="text-[#55FFFF] font-semibold">Glacite</span>
            <span class="text-[#55FFFF] font-bold">{{ format(total.glacite) }}</span>
          </div>
        </div>
        <div class="my-4 border-t border-gray-600"></div>
        <div class="flex flex-col items-center justify-center p-4 rounded-lg bg-indigo-700">
          <span class="text-gray-200 text-lg font-bold tracking-wide">{{ hotmServ.usedTokens }}</span>
          <span class="text-gray-200 font-semibold text-sm">tokens used</span>
        </div>
      </div>

      <!-- Tools panel -->
      <div class="bg-gray-800/40 p-6 rounded-md !border-gray-500 border">
        <h2 class="text-xl font-bold text-sky-300 mb-4">Tools</h2>
        <div class="mb-6 gap-3 justify-center items-center grid md:grid-cols-2 grid-cols-1">
          <button
            type="button"
            (click)="hotmServ.freeMode = !hotmServ.freeMode"
            [ngClass]="
              'h-8 w-full font-semibold rounded-lg transition-colors flex items-center justify-center ' +
              (hotmServ.freeMode ? 'border border-green-600 bg-green-600 text-white hover:bg-green-700' : 'border border-gray-500 bg-gray-700 text-sky-300 hover:bg-indigo-500/80 hover:text-gray-900')
            "
          >
            Free Mode
          </button>
          <button
            type="button"
            class="h-8 w-full border border-slate-400/60 bg-gray-700 text-slate-400 font-semibold rounded-lg transition-colors flex items-center justify-center opacity-60 cursor-not-allowed"
            disabled
          >
            Log in
          </button>
        </div>
        <div class="mb-6">
          <div class="space-y-3">
            <div>
              <label for="predefined-tree" class="block mb-1 text-sm text-white font-semibold"> Load Predefined
                Tree </label>
              <p-select
                [disabled]="true"
                id="predefined-tree"
                [options]="predefinedTrees"
                placeholder="Select a tree"
                [styleClass]="'w-full bg-gray-700 text-white border-white focus:ring-2 focus:ring-white rounded-lg'"
              ></p-select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button type="button"
                      class="h-10 w-full border border-slate-400/60 bg-gray-700 text-slate-300 font-semibold rounded-lg transition-colors hover:bg-slate-300 hover:text-gray-900"
                      (click)="onExportClick()"
              >
                Export
              </button>
              <button type="button"
                      class="w-full border border-slate-400/60 bg-gray-700 text-slate-300 font-semibold rounded-lg transition-colors hover:bg-slate-300 hover:text-gray-900"
                      (click)="onImportClick()"
              >
                Import
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p-toast
    [breakpoints]="{ '920px': { width: '90%', right: '-5%', left: '5%' } }"
  ></p-toast>
</div>
