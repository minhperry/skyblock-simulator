<div class="flex justify-center flex-col lg:flex-row container mx-auto pb-4 select-none">
  <!-- Left panel: the grid -->
  <div class="inventory-view container">
    @for (row of hotmServ.grid; let rwIdx = $index; track rwIdx) {
      @for (cell of row; let colIdx = $index; track colIdx) {
        @if (cell) {
          <div class="inventory-slot rich-item"
               (click)="onCellClick(colIdx, rwIdx)"
               [id]="'cell_' + colIdx + '_' + rwIdx"
               [ngClass]="{'selected': selectedPos()?.x === colIdx && selectedPos()!.y === rwIdx}"
          >
            <div class="item-icon piece-icon" [ngClass]="cell.cssClass()()"></div>
          </div>
        } @else {
          <div class="inventory-slot" [id]="'cell_' + colIdx + '_' + rwIdx"></div>
        }
      }
    }
  </div>
  <!-- Right panel: the picker -->
  <div class="container flex justify-center flex-col max-lg:flex-col-reverse max-lg:mt-4 gap-3">
    <div id="tooltip-box" class="h-[50%] flex justify-center items-center">
      <div class="tooltip-mc px-3">
        @if (selectedPos()) {
          @let pos = selectedPos()!;
          @let selectedNode = hotmServ.grid[pos.y][pos.x];
          @switch (selectedNode.type) {
            @case ('ability') {
              <sb-hotm-card [instance]="selectedNode" [isLevelable]="false"/>
            }
            @case ('static') {
              <sb-hotm-card [instance]="selectedNode" [isLevelable]="false"/>
            }
            @case ('levelable') {
              <sb-hotm-card [instance]="selectedNode" [isLevelable]="true"/>
            }
          }
        } @else {
          <div class="flex flex-col justify-center items-center">
            <span class="mc gray">Select a perk to see its description!</span>
          </div>
        }
      </div>
    </div>
    <div class="h-[50%] flex justify-center items-center flex-col">
      <span class="font-semibold text-xl">Total</span>
      @let total = hotmServ.totalPowder();
      <span [innerHTML]="formattedPowderString(total.mithril, PowderType.MITHRIL) | colorize | parse | safeHtml"></span>
      <span [innerHTML]="formattedPowderString(total.gemstone, PowderType.GEMSTONE) | colorize | parse | safeHtml"></span>
      <span [innerHTML]="formattedPowderString(total.glacite, PowderType.GLACITE) | colorize | parse | safeHtml"></span>
      <br/>
      <span>{{ hotmServ.maxAllowedTokens }} token(s) left</span>
      <!-- Disabled for now -->
      <div class="mt-2">
        <p-button (onClick)="openDialog()">
          Log in
        </p-button>
        <p-dialog header="Log in" [modal]="true" [(visible)]="dialogVisible" styleClass="mx-8 lg:w-6/12">
          <div class="flex flex-col h-fit">
            <!-- RAT warning -->
            <div class="flex justify-center">
              <p-message closable severity="warn"
                         styleClass="w-full">
                <i class="bi bi-exclamation-triangle text-yellow-400 text-xl mr-4"></i>
                <div>
                  <p>
                    This form only requires your Minecraft username as well as your profile info. <br/>
                    We would <span class="font-bold text-yellow-300">NEVER</span> need your email for any reason!
                  </p>
                  <p>
                    See <a href="https://hypixel.net/threads/5231557/" target="_blank"
                           class="font-semibold underline text-yellow-200">this Hypixel Forum</a> post to learn
                    more about account security!
                  </p>
                </div>
              </p-message>
            </div>
            <!-- Actual input form -->
            <div class="flex flex-col gap-4 mt-6">
              <!-- Username Row -->
              <div class="flex items-center gap-2">
                <label for="ign" class="w-32">Minecraft name:</label>
                <input id="ign" type="text" pInputText [(ngModel)]="ign"
                       class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white"
                />
                <p-button (onClick)="submitUsername()">Find profiles</p-button>
              </div>

              <!-- Profiles Row -->
              <div class="flex items-center gap-2">
                <label for="profiles" class="w-32">Profile:</label>
                <p-select appendTo="body" id="profiles" [options]="profiles" [(ngModel)]="selectedProfile"
                          optionLabel="displayName"
                          class="flex-1 bg-gray-800 text-white" [disabled]="selectDisabled"
                          styleClass="w-full bg-gray-800 text-white border border-gray-600 rounded"
                ></p-select>
              </div>
              <div class="flex justify-end gap-2">
                <p-button label="Cancel" severity="secondary" (onClick)="dialogVisible = false"/>
                <p-button label="Load data"/>
              </div>
            </div>
          </div>
        </p-dialog>
      </div>
    </div>
  </div>
</div>
